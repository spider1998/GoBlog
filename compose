version: '2'
services:
  gateway:
    image: registry.sdkeji.top/sdkeji/gateway:master
    ports:
    - ${API_PORT}:80
    - ${MINIO_PORT}:9000
    - ${NSQ_ADMIN_PORT}:4171
    restart: unless-stopped

  platform:
    image: registry.sdkeji.top/sdkeji/platform:master
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  personnel:
    image: registry.sdkeji.top/sdkeji/personnel:master
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  verification:
    image: registry.sdkeji.top/sdkeji/verification:master
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  device:
    image: registry.sdkeji.top/sdkeji/device:master
    env_file:
    - ${PWD}/env/common.env
    ports:
    - ${LISTENER_PORT}:9020
    restart: unless-stopped

  enterprise:
    image: registry.sdkeji.top/sdkeji/enterprise:develop
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  ruledemo:
    image: registry.sdkeji.top/sdkeji/ruledemo:master
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  visitor:
    image: registry.sdkeji.top/sdkeji/visitor:develop
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  payment:
    image: registry.sdkeji.top/sdkeji/payment:master
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  s3:
    image: registry.sdkeji.top/sdkeji/s3:master
    env_file:
    - ${PWD}/env/common.env
    restart: unless-stopped

  backup:
    image: registry.sdkeji.top/sdkeji/backup:master
    env_file:
    - ${PWD}/env/common.env
    volumes:
    - ${PWD}/env:/app/env
    - ${PWD}/docker-compose.yml:/app/docker-compose.yml
    - ${PWD}/backups:/app/backups
    - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  mysql:
    image: mysql:5.7.16
    ports:
    - ${MYSQL_PORT}:3306
    volumes:
    - ${PWD}/mysql_data:/var/lib/mysql
    environment:
    - TZ=Asia/Shanghai
    - MYSQL_ROOT_PASSWORD=shengdian
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    restart: unless-stopped

  redis:
    image: redis:3
    ports:
    - 6379:6379
    restart: unless-stopped

  etcd:
    image: 'bitnami/etcd:latest'
    ports:
    - 2379:2379
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCDCTL_API=3
    restart: unless-stopped

  minio:
    image: 'minio/minio:RELEASE.2019-01-23T23-18-58Z'
    volumes:
    - ${PWD}/minio_data:/data
    environment:
    - MINIO_ACCESS_KEY=sdkeji
    - MINIO_SECRET_KEY=sdkeji.com
    command: server /data
    restart: unless-stopped

  nsqlookupd:
    image: nsqio/nsq
    command: /nsqlookupd
    restart: unless-stopped

  nsqd:
    image: nsqio/nsq
    command: /nsqd --lookupd-tcp-address=nsqlookupd:4160
    depends_on:
      - nsqlookupd
    ports:
    - 4150:4150
    restart: unless-stopped

  nsqadmin:
    image: nsqio/nsq
    command: /nsqadmin --lookupd-http-address=nsqlookupd:4161
    depends_on:
      - nsqlookupd
    restart: unless-stopped
